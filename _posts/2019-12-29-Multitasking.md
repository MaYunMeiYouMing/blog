---
layout: post
title:  "Multitasking"
date:   2019-12-29 13:45:01 +0800
categories: Assembly
tag: 80386
---

* content
{:toc}

>本文为原创

为了提供有效的，受保护的多任务处理，80386采用了几种特殊的数据结构。但是，它没有使用特殊的指令来控制多任务。相反，当它们引用特殊数据结构时，它会以不同的方式去解释普通控制传递指令。支持多任务的寄存器和数据结构有：

+ 任务状态段（Task state segment）

+ 任务状态段描述符（Task state segment descriptor）

+ 任务寄存器（Task register）

+ 任务门描述符（Task gate descriptor）

使用这些结构，80386可以快速的从一个任务切换到另一个任务，并且保存原始任务的上下文，以便以后可以重新启动该任务。除了简单的任务切换之外，80386还提供了另外两个任务管理功能：

1. 中断和异常可能导致任务切换（如果系统设计需要）。处理器不仅需要自动切换到处理中断或异常的任务，而且在处理中断或异常后也自动切换回被中断的任务。Interrupt tasks may interrupt lower-priority interrupt tasks to any depth.

2. 每次切换到另一个任务时，80386也可以切换到另一个LDT和另一个页目录。因此，每个任务可以具有逻辑到线性地址的不同映射以及线性到物理地址的不同映射。这是另一种保护功能，因为可以隔离任务并防止它们相互干扰。

# 任务状态段（Task state segment）

处理器管理任务所需的所有信息都存储在特殊类型的段中，即任务状态段（TSS）。[Figure 7-1](#01)显示了用于执行80386任务的TSS格式。

TSS的字段分为两类：

1. 处理器随着任务的每一次切换而更新动态集。该集合包括存储以下内容的字段：
+ 通用寄存器（EAX，ECX，EDX，EBX，ESP，EBP，ESI，EDI）
+ 段寄存器（ES，CS，SS，DS，FS，GS）
+ 标志寄存器（EFLAGS）
+ 指令指针（EIP）
+ 先前执行的任务的TSS的selector（仅在可能返回时更新）

2. 处理器读取但不会更改的静态集。该集合包括存储以下内容的字段：

+ 任务的LDT的selector

+ 包含任务页目录基址的寄存器（PDBR）（仅在启用分页时才只读）

+ 指向特权级别0-2的堆栈的指针。

+ T位（调试陷阱位），当任务切换发生时，导致处理器触发调试异常。

+ The I/O map base

任务状态段可以位于线性空间中的任何位置。唯一需要注意的情况是TSS跨越页面边界以及高地址页面不存在。在这种情况下，如果在任务切换期间读取TSS时处理器遇到不存在的页面，则会引发异常。可以通过以下两种策略之一避免此类异常：

1. 通过分配TSS，使其不跨越页面边界。

2. 通过确保在任务切换时两个页面都存在或不存在。如果两个页面都不存在，那么缺页异常处理程序必须在重新启动导致任务切换的指令之前使两个页面都存在。

<span id="01">
![]({{ '/styles/images/2019-12-29-Multitasking/01.gif' | prepend: site.baseurl }})